<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Election Management ‚Äì State Forge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="tailwind.css">
</head>
<body class="bg-gray-50 font-sans min-h-screen">

  <!-- NAVBAR -->
  <nav class="bg-legend-blue text-white px-6 py-4 flex items-center justify-between shadow">
    <div class="flex items-center gap-3">
      <img src="images/State-Forge-Shield-White-on-Blue.png" alt="Logo" class="w-8 h-8 p-1 rounded-full" />
      <span class="text-xl font-semibold">State Forge <span class="text-sm font-normal text-legend-gold ml-2">Admin Portal</span></span>
    </div>
    <button id="logoutBtn" type="button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-2xl shadow transition" aria-label="Logout">Logout</button>
  </nav>

  <main class="flex-1 p-6 lg:p-10 bg-gray-50 min-h-screen">
    <a href="console.html" class="inline-flex items-center text-legend-blue font-semibold mb-4 hover:underline group">
      <span class="mr-2 text-lg">&larr;</span>
      Back to Dashboard
    </a>

    <div id="program-selector" class="mb-6"></div>

    <h1 class="text-3xl font-extrabold text-legend-blue mb-2">Election Management</h1>
    <p class="text-gray-700 mb-4">Open elections, manage nominations, and track candidates for your program.</p>

    <div class="bg-blue-50 border-l-4 border-legend-blue p-4 mb-8 rounded">
      <p class="text-sm text-gray-700 mb-3">
        <strong>Workflow:</strong> Select a level to open nominations for elections. Staff members can then nominate candidates. Once nominations close and requirements are verified, you can start the election.
      </p>
      <p class="text-sm text-gray-700 mb-3">
        <strong>Election Types:</strong> Partisan positions have a Primary election followed by a General election. Non-partisan positions go directly to General election.
      </p>
      <p class="text-sm text-gray-700">
        <strong>Testing:</strong> <a id="vote-simulation-link" href="vote-simulation.html" class="text-legend-blue font-semibold hover:underline">Open Vote Simulation Tool</a> to simulate voting for active elections (admin only).
      </p>
    </div>

    <!-- Voting Portal Launch Section -->
    <div data-permission="elections.voting_portal" class="bg-white rounded-2xl shadow-lg p-6 mb-8 border-l-4 border-green-500">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h2 class="text-xl font-bold text-legend-blue">Voting Portal</h2>
          <p class="text-sm text-gray-600 mt-1">Launch the public voting portal for delegates, or test voting as a specific delegate.</p>
        </div>
        <div class="flex gap-3 flex-wrap">
          <button id="launch-voting-portal-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
            </svg>
            Launch Delegate Portal
          </button>
          <a id="admin-voting-portal-link" href="voting-portal-admin.html" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            Test Voting (Admin)
          </a>
        </div>
      </div>
    </div>

    <!-- Year Selector -->
    <div class="mb-6">
      <label for="year-select" class="block text-sm font-medium text-gray-700 mb-1">Program Year</label>
      <select id="year-select" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-legend-blue">
        <option value="">Select a year...</option>
      </select>
    </div>

    <!-- Error/Success Messages -->
    <div id="errorBox" class="hidden bg-red-100 text-red-700 px-4 py-3 rounded-xl mb-4 shadow"></div>
    <div id="successBox" class="hidden bg-green-100 text-green-700 px-4 py-3 rounded-xl mb-4 shadow"></div>

    <!-- Open Elections Section -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 border-t-4 border-legend-gold">
      <h2 class="text-xl font-bold text-legend-blue mb-4">Open Nominations</h2>
      <p class="text-sm text-gray-600 mb-4">Select an organizational level to open nominations for all elected positions at that level.</p>

      <div class="flex flex-wrap gap-4 items-end">
        <div>
          <label for="level-select" class="block text-sm font-medium text-gray-700 mb-1">Organizational Level</label>
          <select id="level-select" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-legend-blue min-w-48">
            <option value="">Select a level...</option>
          </select>
        </div>
        <button id="open-primary-btn" disabled class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition disabled:opacity-50 disabled:cursor-not-allowed">
          Open Primary Nominations
        </button>
        <button id="open-general-btn" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition disabled:opacity-50 disabled:cursor-not-allowed">
          Open General Nominations
        </button>
      </div>

      <div id="positions-preview" class="mt-4 hidden">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">Positions at this level:</h3>
        <div id="positions-list" class="flex flex-wrap gap-2"></div>
      </div>
    </div>

    <!-- KPI Dashboard -->
    <div id="kpi-dashboard" class="hidden mb-8">
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-legend-blue">
          <p class="text-xs text-gray-500 uppercase tracking-wide">Total Elections</p>
          <p id="kpi-total" class="text-2xl font-bold text-legend-blue">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
          <p class="text-xs text-gray-500 uppercase tracking-wide">Nominations Open</p>
          <p id="kpi-nominations" class="text-2xl font-bold text-green-600">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-amber-500">
          <p class="text-xs text-gray-500 uppercase tracking-wide">Scheduled</p>
          <p id="kpi-scheduled" class="text-2xl font-bold text-amber-600">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-blue-500">
          <p class="text-xs text-gray-500 uppercase tracking-wide">Voting Active</p>
          <p id="kpi-active" class="text-2xl font-bold text-blue-600">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-green-600">
          <p class="text-xs text-gray-500 uppercase tracking-wide">100% Return</p>
          <p id="kpi-completed" class="text-2xl font-bold text-green-700">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4 border-l-4 border-purple-500">
          <p class="text-xs text-gray-500 uppercase tracking-wide">Total Votes</p>
          <p id="kpi-votes" class="text-2xl font-bold text-purple-600">0</p>
        </div>
      </div>
    </div>

    <!-- Active Elections Section -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 border-t-4 border-legend-gold">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-bold text-legend-blue">Active Elections</h2>
          <p class="text-sm text-gray-600 mt-1">Elections currently accepting nominations or in progress</p>
        </div>
        <div class="flex gap-2 flex-wrap">
          <select id="filter-level" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-legend-blue text-sm">
            <option value="">All Levels</option>
          </select>
          <select id="filter-status" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-legend-blue text-sm">
            <option value="">All Statuses</option>
            <option value="nomination">Accepting Nominations</option>
            <option value="scheduled">Scheduled</option>
            <option value="active">Voting Active</option>
            <option value="completed">Completed</option>
            <option value="skipped">Appointed</option>
          </select>
          <button id="close-all-nominations-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition text-sm hidden">
            Close All Nominations
          </button>
          <button id="start-all-elections-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition text-sm hidden">
            Start All Elections
          </button>
          <button id="close-all-elections-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition text-sm hidden">
            Close All Active Elections
          </button>
        </div>
      </div>

      <!-- Status Summary Bar -->
      <div id="status-summary" class="flex flex-wrap gap-2 mb-4 hidden">
        <button data-status="" class="status-chip px-3 py-1.5 rounded-full text-sm font-medium transition border-2 border-legend-blue bg-legend-blue text-white">
          All <span class="status-count ml-1 opacity-75"></span>
        </button>
        <button data-status="nomination" class="status-chip px-3 py-1.5 rounded-full text-sm font-medium transition border-2 border-amber-500 bg-white text-amber-700 hover:bg-amber-50">
          üìã Nominations <span class="status-count ml-1 font-bold">0</span>
        </button>
        <button data-status="scheduled" class="status-chip px-3 py-1.5 rounded-full text-sm font-medium transition border-2 border-blue-500 bg-white text-blue-700 hover:bg-blue-50">
          üìÖ Scheduled <span class="status-count ml-1 font-bold">0</span>
        </button>
        <button data-status="active" class="status-chip px-3 py-1.5 rounded-full text-sm font-medium transition border-2 border-green-500 bg-white text-green-700 hover:bg-green-50">
          üó≥Ô∏è Voting <span class="status-count ml-1 font-bold">0</span>
        </button>
        <button data-status="completed" class="status-chip px-3 py-1.5 rounded-full text-sm font-medium transition border-2 border-gray-400 bg-white text-gray-600 hover:bg-gray-50">
          ‚úÖ Completed <span class="status-count ml-1 font-bold">0</span>
        </button>
        <button data-status="skipped" class="status-chip px-3 py-1.5 rounded-full text-sm font-medium transition border-2 border-purple-500 bg-white text-purple-700 hover:bg-purple-50">
          üë§ Appointed <span class="status-count ml-1 font-bold">0</span>
        </button>
      </div>

      <div id="elections-list" class="space-y-4">
        <p class="text-gray-500 italic">Select a year to view elections...</p>
      </div>
    </div>
  </main>

  <footer class="bg-legend-blue text-white border-t mt-8 py-4 text-center text-xs">
    &copy; 2025 State Forge Admin. Not affiliated with or endorsed by the American Legion.
  </footer>

  <!-- Election Detail Modal -->
  <div id="election-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full mx-4 p-6 relative max-h-[90vh] overflow-y-auto">
      <button id="election-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
      <h3 id="election-modal-title" class="text-xl font-bold text-legend-blue mb-4">Election Details</h3>

      <div id="election-info" class="mb-6">
        <!-- Election info will be populated here -->
      </div>

      <!-- Error message area for election modal -->
      <div id="election-modal-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>

      <!-- Voting Results Section (shown for active/completed elections) -->
      <div id="election-results-section" class="hidden mb-6 border-t border-gray-200 pt-4">
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-lg font-semibold text-legend-blue">Voting Results</h4>
          <button id="refresh-results-btn" class="text-sm text-legend-blue hover:text-blue-800 underline">
            Refresh
          </button>
        </div>
        <div id="election-results-content">
          <!-- Results will be populated here -->
        </div>
      </div>

      <div class="border-t border-gray-200 pt-4">
        <div class="flex items-center justify-between mb-4">
          <h4 class="text-lg font-semibold text-legend-blue">Candidates</h4>
          <div class="flex gap-2">
            <button id="verify-all-candidates-btn" class="bg-amber-100 hover:bg-amber-200 text-amber-800 font-semibold py-1 px-3 rounded-lg transition text-sm hidden" title="Mark all candidates as verified (for testing)">
              ‚úì Verify All
            </button>
            <button id="add-candidate-btn" class="bg-legend-blue hover:bg-blue-800 text-white font-semibold py-1 px-3 rounded-lg shadow transition text-sm">
              + Add Candidate
            </button>
          </div>
        </div>

        <div id="candidates-list" class="space-y-3">
          <p class="text-gray-500 italic">No candidates yet.</p>
        </div>
      </div>

      <div class="flex gap-3 justify-between mt-6 pt-4 border-t">
        <div class="flex gap-2">
          <button id="archive-election-btn" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 font-semibold rounded-lg transition text-sm">
            Archive Election
          </button>
          <button id="skip-to-appointed-btn" class="hidden px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-700 font-semibold rounded-lg transition text-sm">
            Skip &rarr; Appointed
          </button>
        </div>
        <div class="flex gap-3">
          <button id="reopen-nominations-btn" class="hidden px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 font-semibold rounded-lg transition">
            Reopen Nominations
          </button>
          <button id="close-nominations-btn" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg shadow transition hidden">
            Close Nominations
          </button>
          <button id="election-modal-done" class="px-4 py-2 bg-legend-blue hover:bg-blue-800 text-white font-semibold rounded-lg shadow transition">
            Done
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Candidate Modal -->
  <div id="add-candidate-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-6 relative max-h-[90vh] overflow-y-auto">
      <button id="add-candidate-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
      <h3 class="text-xl font-bold text-legend-blue mb-4">Add Candidate</h3>

      <!-- Primary election info -->
      <div id="primary-info-section" class="mb-4 hidden">
        <p class="text-sm text-gray-600">For primary elections, delegates can only run in their own party's primary. Click on a party header to close/reopen nominations for that party.</p>
      </div>

      <div class="mb-4">
        <label for="candidate-search" class="block text-sm font-medium text-gray-700 mb-1">Search Delegates</label>
        <input
          type="text"
          id="candidate-search"
          placeholder="Type to search by name..."
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-legend-blue"
        />
      </div>

      <!-- Select All row -->
      <div id="select-all-row" class="hidden flex items-center justify-between p-3 bg-gray-100 border border-gray-200 rounded-t-lg">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" id="select-all-checkbox" class="w-4 h-4 text-legend-blue focus:ring-2 focus:ring-legend-blue rounded">
          <span class="text-sm font-medium text-gray-700">Select All</span>
        </label>
        <span id="selection-count" class="text-sm text-gray-500">0 selected</span>
      </div>

      <div id="eligible-delegates-list" class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
        <p class="text-gray-500 italic p-4">Loading eligible delegates...</p>
      </div>

      <div class="flex gap-3 justify-between mt-4">
        <button id="nominate-selected-btn" class="hidden px-4 py-2 bg-legend-blue hover:bg-blue-800 text-white font-semibold rounded-lg shadow transition disabled:opacity-50 disabled:cursor-not-allowed">
          Nominate Selected (0)
        </button>
        <div class="flex-1"></div>
        <button id="cancel-add-candidate-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Candidate Requirements Modal -->
  <div id="candidate-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6 relative">
      <button id="candidate-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
      <h3 id="candidate-modal-title" class="text-xl font-bold text-legend-blue mb-4">Candidate Requirements</h3>

      <div id="candidate-info" class="mb-4">
        <!-- Candidate info will be populated here -->
      </div>

      <div id="requirements-section" class="space-y-4 mb-6">
        <div id="declaration-requirement" class="hidden">
          <label class="flex items-start gap-2 cursor-pointer">
            <input type="checkbox" id="declaration-checkbox" class="w-4 h-4 mt-0.5 text-legend-blue focus:ring-2 focus:ring-legend-blue rounded">
            <div>
              <span class="text-sm text-gray-700 font-medium">Declaration of Candidacy Received</span>
              <p class="text-xs text-gray-500 mt-1" id="declaration-date"></p>
            </div>
          </label>
        </div>

        <div id="petition-requirement" class="hidden">
          <label class="flex items-start gap-2 cursor-pointer">
            <input type="checkbox" id="petition-checkbox" class="w-4 h-4 mt-0.5 text-legend-blue focus:ring-2 focus:ring-legend-blue rounded">
            <div>
              <span class="text-sm text-gray-700 font-medium">Petition Verified</span>
              <p class="text-xs text-gray-500 mt-1" id="petition-date"></p>
            </div>
          </label>
          <div id="petition-signatures-section" class="mt-2 ml-6">
            <label for="petition-signatures-input" class="block text-sm font-medium text-gray-700 mb-1">
              Signature Count <span id="required-signatures" class="text-gray-500 text-xs"></span>
            </label>
            <input
              type="number"
              id="petition-signatures-input"
              placeholder="Number of valid signatures"
              class="w-32 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-legend-blue"
              min="0"
            />
          </div>
        </div>

        <!-- Computed Status Badge -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Candidate Status</label>
          <div class="flex items-center gap-3">
            <span id="candidate-status-badge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"></span>
            <span id="status-hint" class="text-xs text-gray-500"></span>
          </div>
        </div>

        <!-- Withdrawn Checkbox -->
        <div class="mt-3">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="withdrawn-checkbox" class="w-4 h-4 text-red-600 focus:ring-2 focus:ring-red-500 rounded">
            <span class="text-sm text-gray-700 font-medium">Mark as Withdrawn</span>
          </label>
          <p class="text-xs text-gray-500 mt-1 ml-6">Withdrawn candidates are removed from the ballot.</p>
        </div>
      </div>

      <div class="flex gap-3 justify-end">
        <button id="cancel-candidate-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition">
          Cancel
        </button>
        <button id="save-candidate-btn" class="px-4 py-2 bg-legend-blue hover:bg-blue-800 text-white font-semibold rounded-lg shadow transition">
          Save
        </button>
      </div>
    </div>
  </div>

  <!-- Incomplete Requirements Modal -->
  <div id="incomplete-requirements-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-6 relative max-h-[90vh] overflow-hidden flex flex-col">
      <button id="incomplete-requirements-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
      <div class="flex items-center gap-3 mb-4">
        <span class="text-amber-500 text-2xl">‚ö†Ô∏è</span>
        <h3 class="text-xl font-bold text-legend-blue">Cannot Start Elections</h3>
      </div>
      <p class="text-gray-700 mb-4">
        The following candidates have not completed required candidacy forms or petitions.
        All requirements must be met before elections can start.
      </p>
      <div id="incomplete-requirements-list" class="flex-1 overflow-y-auto max-h-96">
        <!-- List will be populated dynamically -->
      </div>
      <div class="flex justify-end mt-4 pt-4 border-t">
        <button id="incomplete-requirements-done-btn" class="px-4 py-2 bg-legend-blue hover:bg-blue-800 text-white font-semibold rounded-lg shadow transition">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <!-- Hidden element to ensure Tailwind compiles dynamic button colors -->
  <div class="hidden bg-amber-500 hover:bg-amber-600 bg-green-600 hover:bg-green-700 bg-legend-blue hover:bg-blue-800"></div>
  <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 relative">
      <h3 id="confirmation-title" class="text-xl font-bold text-legend-blue mb-4"></h3>
      <p id="confirmation-message" class="text-gray-700 mb-4"></p>
      <div id="confirmation-checkbox-container" class="hidden mb-4">
        <label class="flex items-center gap-2 text-gray-700 cursor-pointer">
          <input type="checkbox" id="confirmation-checkbox" class="w-4 h-4 text-legend-blue border-gray-300 rounded focus:ring-legend-blue">
          <span id="confirmation-checkbox-label"></span>
        </label>
      </div>
      <div id="confirmation-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
      <div class="flex gap-3 justify-end">
        <button id="confirmation-cancel-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition">Cancel</button>
        <button id="confirmation-confirm-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow transition"></button>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/authHelper.js"></script>
  <script src="js/permissions.js"></script>
  <script src="js/elections-management.js"></script>
</body>
</html>
